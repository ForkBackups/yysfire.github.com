<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Vim 脚本学习笔记</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="幽谷奇峰">

    <!-- Le styles -->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="../google-code-prettify/sons-of-obsidian.css" rel="stylesheet">
    <link href="../mystyle.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../ico/apple-touch-icon-57-precomposed.png">
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../index.html">幽谷奇峰</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="../index.html">主页</a></li>
              <li><a href="../linux/index.html">Linux</a></li>
              <li class="active"><a href="../vim/index.html">Vim</a></li>
              <li><a href="../webdesign/index.html">前端设计</a></li>
              <li><a href="../c_cpp/index.html">C和C++</a></li>
              <li><a href="../python/index.html">Python</a></li>
              <li class="divider-vertical"></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">联系我 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="https://twitter.com/yysfirecn">@推一推我</a></li>
                  <li><a href="https://www.facebook.com/yaley2">君要你死</a></li>
                  <li><a href="../about.html">给我写信</a></li>
                </ul> <!--/.dropdown-menu -->
              </li> <!--/.dropdown -->
            </ul> <!--/.nav -->
          </div> <!--/.nav-collapse -->

          <div class="pull-right">
            <form class="navbar-search" action="/search.html">
              <!--<div class="input-append">-->
                <input type="text" name="q" class="search-query input-medium" placeholder="搜索">
                <button type="submit" class="icon nav-search"><i class="icon-search icon-white"></i></button>
              <!--</div>-->
            </form>
          </div>

        </div> <!-- /.container -->
      </div> <!--/.navbar-inner-->
    </div> <!--/.navbar-->
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span9">
          <ul class="breadcrumb">
            <li>
            <a href="../index.html">首页</a> <span class="divider">/</span>
            </li>
            <li>
            <a href="../vim/index.html">Vim</a> <span class="divider">/</span>
            </li>
            <li class="active">你的位置</li>
          </ul>
          
<div class="toc">
<ul>
<li><a href="#toc_1">Vim 脚本学习笔记</a>
<ul>
<li><a href="#toc_1.1">变量</a>
<li><a href="#toc_1.2"><code>exists()</code>函数</a>
<li><a href="#toc_1.3">Vimscript 中的真和假</a>
<li><a href="#toc_1.4">字符串常量</a>
<li><a href="#toc_1.5">表达式</a>
<li><a href="#toc_1.6">逻辑操作</a>
<li><a href="#toc_1.7">字符串比较</a>
<li><a href="#toc_1.8">命令的续行与拼接</a>
<li><a href="#toc_1.9">算术说明</a>
<li><a href="#toc_1.10"><code>execute</code> 与 <code>normal</code> 命令</a>
<li><a href="#toc_1.11">函数</a>
<ul>
<li><a href="#toc_1.11.1">范围的使用</a>
<li><a href="#toc_1.11.2">可变参数</a>
<li><a href="#toc_1.11.3">函数引用</a>
<li><a href="#toc_1.11.4">函数封装</a>
</ul>
<li><a href="#toc_1.12">编写插件</a>
<ul>
<li><a href="#toc_1.12.1">用户命令</a>
</ul>
</ul>
</ul>
</div>
<hr />
<p>
<em>修改记录</em>
</p>
<ul>
<li>
Last Modified: 2012-12-05 15:43:44

<li>
First Created: 2012-12-04 11:20:41

</ul>
<hr />
<h1 id="toc_1">Vim 脚本学习笔记</h1>

<h2 id="toc_1.1">变量</h2>

<p>
Vimscript 变量范围
</p>

<table>
<tr>
<th>
前缀
</th>
<th>
含义
</th>
</tr>
<tr>
<td>
g: varname
</td>
<td>
变量为全局变量
</td>
</tr>
<tr>
<td>
s: varname
</td>
<td>
变量的范围为当前的脚本文件
</td>
</tr>
<tr>
<td>
w: varname
</td>
<td>
变量的范围为当前的编辑器窗口
</td>
</tr>
<tr>
<td>
t: varname
</td>
<td>
变量的范围为当前的编辑器选项卡
</td>
</tr>
<tr>
<td>
b: varname
</td>
<td>
变量的范围为当前的编辑器缓冲区
</td>
</tr>
<tr>
<td>
l: varname
</td>
<td>
变量的范围为当前的函数
</td>
</tr>
<tr>
<td>
a: varname
</td>
<td>
变量是当前函数的一个参数
</td>
</tr>
<tr>
<td>
v: varname
</td>
<td>
变量是 Vim 的预定义变量
</td>
</tr>
</table>

<p>
变量采用 ":let" 命令赋值，同时也占用内存空间。为了删除一个变量可以使用 ":unlet" 命令。例:
</p>
<pre>
	:unlet s:count
</pre>

<p>
这将删除 "s:count" 这个脚本局部变量并释放其占用的内存。如果你并不确定这个变量是否存在，但并不希望系统在它不存在时报错，可以在命令后添加 <code>!</code>:
</p>
<pre>
	:unlet! s:count
</pre>

<p>
当一个脚本结束时，它使用的局部变量不会自动被删除。下一次脚本被执行时，旧的变量值仍可被使用。
</p>

<h2 id="toc_1.2"><code>exists()</code>函数</h2>

<p>
"exists()" 函数检查一个变量是否已经被定义过了。它的参数是你想检查的变量的名字。而不是变量本身！如果你这样做:
</p>
<pre>
	:if !exists(s:call_count)
</pre>

<p>
那么变量 s:call_count 的值将被用来做检测。你不会得到想的结果。
</p>

<h2 id="toc_1.3">Vimscript 中的真和假</h2>

<p>
Vim 把任何非零的值当作真。零代表假。
</p>

<p>
如果期待数值类型，Vim 自动把字符串转换为数值。如果使用不以数位开始的字符串，返回的数值为零。所以小心这种代码:
</p>
<pre>
        :if "true"
</pre>
<p>
这里 "true" 会被解读为零，也就是假值！
</p>

<h2 id="toc_1.4">字符串常量</h2>

<p>
你需要使用字符串常量来为字符串变量赋值。字符串常量有两种。第一种是由双引号括起来的，里面可以包含转义序列，例如，<code>\n</code>用于换行，<code>\"</code>用于双引号，<code>\u263A</code>用于 Unicode 笑脸标志，<code>\&lt;ESC&gt;</code>用于 Escape 键。
</p>

<p>
如果你不想使用反斜杠，也可以用单引号括起字符串。所有的字符在单引号内都保持其本来面目，只有单引号本身例外: 输入两个你会得到一个单引号。 因为反斜杠在其中也被作为其本身来对待，你无法使用它来改变其后的字符的意义。
</p>

<h2 id="toc_1.5">表达式</h2>

<p>
已经提到的那些数值，字符串常量和变量都属于表达式。因此任何可以使用表达式的地方，数值，字符串变量和常量都可以使用。其它基本的表达式有:
<table>
<tr>
<th>
表达式
</th>
<th>
含义
</th>
</tr>
<tr>
<td>
$NAME
</td>
<td>
环境变量
</td>
</tr>
<tr>
<td>
&amp;name
</td>
<td>
选项
</td>
</tr>
<tr>
<td>
@r
</td>
<td>
寄存器
</td>
</tr>
</table>
</p>

<p>
一般的，当 ":echo" 命令遇到多个参数时，会在它们之间加入空格。
</p>

<h2 id="toc_1.6">逻辑操作</h2>

<p>
对数值和字符串都可以做逻辑操作。两个字符串的算术差被用来比较它们的值。这个结果是通过字节值来计算的，对于某些语言，这样做的结果未必正确。
</p>

<p>
在比较一个字符串和一个数值时，该字符串将先被转换成一个数值。这容易出错，因为当一个字符串看起来不像数值时，它会被当作 0 对待。
</p>

<h2 id="toc_1.7">字符串比较</h2>

<p>
对于字符串来说还有两种操作:
<table>
<tr>
<th>
操作
</th>
<th>
含义
</th>
</tr>
<tr>
<td>
a =~ b
</td>
<td>
匹配
</td>
</tr>
<tr>
<td>
a !~ b
</td>
<td>
不匹配
</td>
</tr>
</table>
</p>

<p>
左边的 "a" 被当作一个字符串。右边的 "b" 被当作一个匹配模式，正如做查找操作一样。
</p>

<p>
在做字符串比较时用到 'ignorecase' 选项。如果你不希望使用该选项，可以在比较时加上 "#" 或 "?"。"#" 表示大小写敏感；"?" 表示忽略大小写。因此 "==?" 比较两字符串是否相等，不计大小写。"!~#" 检查一个模式是否被匹配，同时也考虑大小写。
</p>

<p>
":sleep" 命令使 Vim 小憩一下。"50m" 表示休息 50 毫秒。再举一个例子，":sleep 4" 休息 4 秒。
</p>

<h2 id="toc_1.8">命令的续行与拼接</h2>

<p>
Vimscript 中一条较长的命令可以分割成多行来写，但必须用反斜杠来作为续行符，反斜杠作为续行符一般写在下一行的开头。
</p>

<p>
相反地，多条命令也可以通过 '|' 字符拼接到一行中来。
</p>

<h2 id="toc_1.9">算术说明</h2>

<p>
在使用算术表达式时，还需要记住一点，在版本 7.2 之前，Vim 只支持整数运算。早期版本中的一个普遍错误是编写类似下面的代码：
</p>
<pre>
"Step through each file...
for filenum in range(filecount)
    " Show progress...
    echo (filenum / filecount * 100) . '% done'
    " Make progress...
   call process_file(filenum)
endfor
</pre>
<p>
由于 filenum 始终小于 filecount，整数除法 filenum/filecount 将始终生成 0，因此每次迭代循环都将生成：<code>Now 0% done</code>
</p>

<p>
即使对于版本 7.2，如果其中一个运算对象被明确声明为浮点类型，那么 Vim 只支持浮点算术：
</p>
<pre>
    let filecount = 234
    echo filecount/100   |" echoes 2
    echo filecount/100.0 |" echoes 2.34
</pre>

<p>
到目前为止，脚本内的语句都是由 Vim 直接运行的。用 ":execute" 命令可以执行一个表达式的结果。这是一个创建并执行命令的非常有效的方法。
</p>

<h2 id="toc_1.10"><code>execute</code> 与 <code>normal</code> 命令</h2>

<p>
":execute" 命令只能用来执行冒号命令。":normal" 命令可以用来执行普通模式命令。然而，它的参数只能是按表面意义解释的命令字符，不能是表达式。例如:为了使 ":normal" 命令也可以带表达式，可以把 ":execute" 与其连起来使用。
</p>
<pre>
	:execute "normal " . normal_commands
</pre>

<p>
变量 "normal_commands" 必须包含要执行的普通模式命令。
</p>

<p>
必须确保 ":normal" 的参数是一个完整的命令。否则，Vim 碰到参数的结尾就会中止其运行。例如，如果你开始了插入模式，你必须也退出插入模式。
</p>

<h2 id="toc_1.11">函数</h2>

<p>
Vim 允许你定义自己的函数。基本的函数声明如下:
</p>
<pre>
	:function {name}({var1}, {var2}, ...)
	:  {body}
	:endfunction
</pre>
<p>
<strong>注意: 函数名必须以大写字母开始。</strong>
</p>

<p>
当一个函数执行到 ":endfunction" 或 ":return" 语句没有带参数时，该函数返回零。
</p>

<p>
如果要重定义一个已经存在的函数，在 "function" 命令后加上<code>!</code>.
</p>

<h3 id="toc_1.11.1">范围的使用</h3>

<p>
":call" 命令可以带一个行表示的范围。这可以分成两种情况。当一个函数定义时给出了 "range" 关键字时，表示它会自行处理该范围。
</p>

<p>
Vim 在调用这样一个函数时给它传递两个参数: "a:firstline" 和 "a:lastline"，用来表示该范围所包括的第一行和最后一行。例如:
</p>
<pre>
	:function Count_words() range
	:  let lnum = a:firstline
	:  let n = 0
	:  while lnum &lt;= a:lastline
	:    let n = n + len(split(getline(lnum)))
	:    let lnum = lnum + 1
	:  endwhile
	:  echo "found " . n . " words"
	:endfunction
</pre>
<p>
你可以这样调用上面的函数:
</p>
<pre>
	:10,30call Count_words()
</pre>

<p>
这个函数将被调用一次并显示字数。
</p>

<p>
另一种使用范围的方式是在定义函数时不给出 "range" 关键字。Vim 将把光标移动到范围内的每一行，并分别对该行调用此函数。例如:
</p>
<pre>
	:function  Number()
	:  echo "line " . line(".") . " contains: " . getline(".")
	:endfunction
</pre>

<p>
如果你用下面的方式调用该函数:
</p>
<pre>
	:10,15call Number()
</pre>

<p>
它将被执行六次。
</p>

<h3 id="toc_1.11.2">可变参数</h3>

<p>
Vim 允许你定义参数个数可变的函数。下面的例子给出一个至少有一个参数 (start)，但
可以多达 20 个附加参数的函数:
</p>
<pre>
	:function Show(start, ...)
</pre>

<p>
变量 "a:1" 表示第一个可选的参数，"a:2" 表示第二个，如此类推。变量 "a:0" 表示
这些参数的个数。例如:
</p>
<pre>
	:function Show(start, ...)
	:  echohl Title
	:  echo "Show is " . a:start
	:  echohl None
	:  let index = 1
	:  while index &lt;= a:0
	:    echo "  Arg " . index . " is " . a:{index}
	:    let index = index + 1
	:  endwhile
	:  echo ""
	:endfunction
</pre>
<p>
上例中 ":echohl" 命令被用来给出接下来的 ":echo" 命令如何高亮输出。":echohl None" 终止高亮。":echon" 命令除了不输出换行符外，和 ":echo" 一样。
</p>

<p>
你可以用 a:000 变量，它是所有 "..." 参数的列表。详情见 <code>help: a:000</code> 。
</p>

<h3 id="toc_1.11.3">函数引用</h3>

<p>
有时使变量指向一个或另一个函数可能有用。要这么做，用 function() 函数。它把函数名转换为引用。
</p>

<p>
<strong>注意 保存函数引用的变量名必须用大写字母开头，不然和内建函数的名字会引起混淆。</strong>
</p>

<p>
调用变量指向的函数可以用 call() 函数。它的第一个参数是函数引用，第二个参数是参数构成的列表。
</p>

<p>
字典项目通常可以用方括号里的索引得到:
</p>
<pre>
	:echo uk2nl['one']
	een ~
</pre>

<p>
完成同样操作且无需那么多标点符号的方法:
</p>
<pre>
	:echo uk2nl.one
	een ~
</pre>

<p>
这只能用于由 ASCII 字母、数位和下划线组成的键。此方式也可以用于赋值。
</p>

<h3 id="toc_1.11.4">函数封装</h3>

<p>
为了避免你的函数名同其它的函数名发生冲突，使用这样的方法:
</p>
<ul>
<li>
在函数名前加上独特的字符串。我通常使用一个缩写。例如，"OW_" 被用在 option
  window 函数上。

<li>
将你的函数定义放在一个文件内。设置一个全局变量用来表示这些函数是否已经被加载
  了。当再次 source 这个文件的时候，先将这些函数卸载。

</ul>

<h2 id="toc_1.12">编写插件</h2>

<p>
首先你得给你的插件起个名字。这个名字应该很清楚地表示该插件的用途。同时应该避免同别的插件用同样的名字而用途不同。请将插件名限制在 8 个字符以内，这样可以使得该插件在老的 Windows 系统也能使用。
</p>

<p>
&lt;SID&gt; 和 &lt;Plug&gt; 都是用来避免映射的键序列和那些仅仅用于其它映射的映射起冲突。
</p>

<p>
注意 &lt;SID&gt; 和 &lt;Plug&gt; 的区别:
<table>
<tr>
<th>
标志
</th>
<th>
说明
</th>
</tr>
<tr>
<td rowspan="6">
&lt;Plug&gt;
</td>
<td>
在脚本外部是可见的。它被用来定义那些用户可能定义映射的映射。&lt;Plug&gt; 是
</td>
</tr>
<tr>
<td>
无法用键盘输入的特殊代码。
</td>
</tr>
<tr>
<td>
使用结构：&lt;Plug&gt; 脚本名 映射名，可以使得其它插件使用同样次序的字符来定
</td>
</tr>
<tr>
<td>
义映射的几率变得非常小。在我们上面的例子中，脚本名是 "Typecorr"，映射
</td>
</tr>
<tr>
<td>
名是 "Add"。结果是 "&lt;Plug&gt;TypecorrAdd"。只有脚本名和映射名的第一个字
</td>
</tr>
<tr>
<td>
符是大写的，所以我们可以清楚地看到映射名从什么地方开始。
</td>
</tr>
<tr>
<td rowspan="6">
&lt;SID&gt;
</td>
<td>
是脚本的 ID，用来唯一的代表一个脚本。Vim 在内部将 &lt;SID&gt; 翻译为
</td>
</tr>
<tr>
<td>
"&lt;SNR&gt;123_"，其中 "123" 可以是任何数字。这样一个函数 "&lt;SID&gt;Add()" 可能
</td>
</tr>
<tr>
<td>
在一个脚本中被命名为 "&lt;SNR&gt;11_Add()"，而在另一个脚本中被命名为
</td>
</tr>
<tr>
<td>
"&lt;SNR&gt;22_Add()"。如果你用 ":function" 命令来获得系统中的函数列表你就可
</td>
</tr>
<tr>
<td>
以看到了。映射中对 &lt;SID&gt; 的翻译是完全一样的。这样你才有可能通过一个映
</td>
</tr>
<tr>
<td>
射来调用某个脚本中的局部函数。
</td>
</tr>
</table>
</p>

<p>
关于插件的小结:
</p>

<table>
<tr>
<td>
s:name
</td>
<td>
脚本的局部变量。
</td>
</tr>
<tr>
<td>
&lt;SID&gt;
</td>
<td>
脚本 ID，用于局部于脚本的映射和函数。
</td>
</tr>
<tr>
<td>
hasmapto()
</td>
<td>
用来检测插件定义的映射是否已经存在的函数。
</td>
</tr>
<tr>
<td>
&lt;Leader&gt;
</td>
<td>
"mapleader" 的值。用户可以通过该变量定义插件所定义映射
</td>
</tr>
<tr>
<td>
:map &lt;unique&gt;
</td>
<td>
如果一个映射已经存在的话，给出警告信息。
</td>
</tr>
<tr>
<td>
:noremap &lt;script&gt;
</td>
<td>
在映射右边仅执行脚本的局部映射，而不检查全局映射。
</td>
</tr>
<tr>
<td>
exists(":Cmd")
</td>
<td>
检查一个用户命令是否存在。
</td>
</tr>
</table>


<h3 id="toc_1.12.1">用户命令</h3>

<p>
在使用 <code>:command</code> 命令时，如果加上 "-buffer" 开关，就可以为某一类型的文件加入一个用户命令，而该命令又只能用于一个缓冲区。例:
</p>
<pre>
	:command -buffer  Make  make %:r.s
</pre>

<p>
以下是有关文件类型插件一些特殊环节：
</p>

<table>
<tr>
<td rowspan="2">
&lt;LocalLeader&gt;
</td>
<td>
"maplocalleader" 的值，用户可以通过它来自定义文件类型
</td>
</tr>
<tr>
<td>
插件中映射的起始字符。
</td>
</tr>
<tr>
<td>
:map &lt;buffer&gt;
</td>
<td>
定义一个仅对缓冲区有效的局部映射。
</td>
</tr>
<tr>
<td>
:noremap &lt;script&gt;
</td>
<td>
仅重映射脚本中以 &lt;SID&gt; 开始的映射。
</td>
</tr>
<tr>
<td>
:setlocal
</td>
<td>
设定仅对当前缓冲区有效的选项。
</td>
</tr>
<tr>
<td>
:command -buffer
</td>
<td>
定义一个仅对缓冲区有效的局部命令。
</td>
</tr>
<tr>
<td>
exists("*s:Func")
</td>
<td>
查看是否已经定义了某个函数。
</td>
</tr>
</table>

<p>
参阅所有插件的特殊环节 <code>:help plugin-special</code>。
</p>

<hr />
<p>
Tags: Vim
</p>

          <div id="copy"></div>
        </div> <!-- /.span9 -->
        <div class="span3">
          <iframe src="http://t.163.com/page/widget.html?yansi|615|1|2" allowTransparency="true" frameborder="0" scrolling="no" width="100%" height="615"></iframe>
        </div> <!-- /.span3 -->
      </div> <!-- /.row-fluid -->

      <footer class="footer">
      <p class="pull-right"><a href="#">回到顶部</a></p>
      <div id=license>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png" /></a>
        <p>除非另有声明，本站作品由<a href="https://twitter.com/yysfirecn">@幽谷奇峰</a>创作，<br />采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可。
        </p>
      </div> 
      <!--/#license-->
      <p>Generated by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>. Powered by <a href="https://github.com">GitHub Pages</a>.</p>
      </footer> <!-- /footer -->
    </div> <!-- /.container-fluid -->

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="../bootstrap/js/bootstrap.min.js"></script>
    <script src="../google-code-prettify/prettify.js"></script>
    <script src="../myapp.js"></script>

    <!-- Baidu Button BEGIN -->
    <script type="text/javascript" id="bdshare_js" data="type=slide&img=7&pos=right&uid=774188" ></script>
    <script type="text/javascript" id="bdshell_js"></script>
    <script type="text/javascript">
      var bds_config = {"bdTop":300};
      document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + new Date().getHours();
    </script>
    <!-- Baidu Button END -->
  </body>
</html>

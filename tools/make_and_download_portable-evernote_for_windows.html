<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Windows平台便携版Evernote的制作与下载</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="幽谷奇峰">

    <!-- Le styles -->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="../google-code-prettify/sons-of-obsidian.css" rel="stylesheet">
    <link href="../mystyle.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../ico/apple-touch-icon-57-precomposed.png">
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../main.html">幽谷奇峰</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="../main.html">主页</a></li>
              <li><a href="../linux/main.html">Linux</a></li>
              <li><a href="../vim/main.html">Vim</a></li>
              <li><a href="../web/main.html">前端</a></li>
              <li><a href="../c_cpp/main.html">C和C++</a></li>
              <li><a href="../python/main.html">Python</a></li>
              <li class="active"><a href="../tools/main.html">工具</a></li>
              <li class="divider-vertical"></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">联系我 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="https://twitter.com/yysfirecn">@推一推我</a></li>
                  <li><a href="https://www.facebook.com/yysfire">君要你死</a></li>
                  <li><a href="../about.html">给我写信</a></li>
                </ul> <!--/.dropdown-menu -->
              </li> <!--/.dropdown -->
            </ul> <!--/.nav -->
          </div> <!--/.nav-collapse -->

          <div class="pull-right">
            <form class="navbar-search" action="../search.html">
              <!--<div class="input-append">-->
                <input type="text" name="q" class="search-query input-medium" placeholder="搜索">
                <button type="submit" class="icon nav-search"><i class="icon-search icon-white"></i></button>
              <!--</div>-->
            </form>
          </div>

        </div> <!-- /.container -->
      </div> <!--/.navbar-inner-->
    </div> <!--/.navbar-->
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span9">
          <ul class="breadcrumb">
            <li>
            <a href="../main.html">首页</a> <span class="divider">/</span>
            </li>
            <li>
            <a href="../python/main.html">Python</a> <span class="divider">/</span>
            </li>
            <li class="active">你的位置</li>
          </ul>
          
<div class="toc">
<ul>
<li><a href="#toc_1">Windows平台便携版Evernote的制作与下载（更新到v5.7.1.5586）</a>
<ul>
<li><a href="#toc_1.1">提取Evernote程序文件</a>
<li><a href="#toc_1.2">分析程序运行机理</a>
<li><a href="#toc_1.3">编写配置文件</a>
<ul>
<li><a href="#toc_1.3.1">appinfo.ini</a>
<li><a href="#toc_1.3.2">图标</a>
<li><a href="#toc_1.3.3">Launcher</a>
<li><a href="#toc_1.3.4">DefaultData</a>
<li><a href="#toc_1.3.5">Custom Code</a>
</ul>
<li><a href="#toc_1.4">编译与封包</a>
<li><a href="#toc_1.5">扩展阅读</a>
<li><a href="#toc_1.6">Evernote便携版下载地址</a>
</ul>
</ul>
</div>

<h1 id="toc_1">Windows平台便携版Evernote的制作与下载（更新到v5.7.1.5586）</h1>

<p>
使用便携软件的好处就不用我赘述了，本人是有着轻微强迫症的便携软件的狂热粉丝，我在windows平台下使用的大部分软件都是便携版的。PortableApps.com Platform 是Windows系统下比较流行的便携软件平台，PortableApps.com Launcher（以下简称PAL）是PortableApps.com开发的便携软件制作工具。本文就介绍如何制作兼容PortableApps.com Platform的便携版Evernote。
</p>

<h2 id="toc_1.1">提取Evernote程序文件</h2>

<p>
先到Evernote官网上下载最新的Evernote安装程序，然后到
<a href="http://legroom.net/software/uniextract">这里</a>
下载提取工具Universal Extractor， 建议下载Archive版（便携版）。
</p>

<p>
不能直接用Universal Extractor提取Evernote官方安装包，否则会出现错误而失败。要先运行一下Evernote官方安装包，等到弹出安装对话框时，点击“取消”退出安装程序，它会在<code>%TEMP%</code>路径（对于Win7就是：C:\Users\Administrator\AppData\Local\Temp）下生成一个名为<code>Evernote.msi</code>的Windows Installer（MSI）包，对此包用Universal Extractor提取就可得到所需的纯净的程序文件。
</p>

<h2 id="toc_1.2">分析程序运行机理</h2>

<p>
运行Evernote，发现它会启动Evernote.exe，EvernoteClipper.exe，EvernoteTray.exe这三个进程，在<code>%APPDATA%</code>、<code>%LOCALAPPDATA%</code>以及NT6.0以上的LocalLow中写入文件，在注册表<code>HKCU\Software\Evernote</code>中写入键值，<code>HKCU\Software\Evernote\Evernote\EvernotePath</code>的值为Evernote数据库的位置。Evernote首次运行还会在<code>shell:sendto</code>中创建一个指向Evernote.exe的快捷方式，以便文件的右键菜单中有“发送到Evernote”的菜单。
</p>

<h2 id="toc_1.3">编写配置文件</h2>

<p>
我们的目标是利用PAL制作这样一个便携软件启动器（Launcher）：
</p>

<p>
<strong>Launcher启动—&gt;备份本地数据—&gt;导入便携数据—&gt;将数据库路径写入注册表—&gt;启动主程序—&gt;主程序退出—&gt;导出便携软件数据—&gt;清理便携软件垃圾—&gt;恢复本地数据—&gt;Launcher退出</strong>
</p>

<p>
PortableApps.com 提供了一个模板：
<a href="http://downloads.sourceforge.net/portableapps/PortableApps.com_Application_Template_2.4.zip">PortableApps.com Application Template 2.4</a>，
以便我们快速部署配置文件。
</p>

<h3 id="toc_1.3.1">appinfo.ini</h3>
<p>
下载上述模板，解压后，重命名AppNamePortable为EvernotePortable。在App下新建Evernote目录，将提取出的程序文件复制到此处。
</p>

<p>
创建 App\AppInfo\appinfo.ini ，此目录下的文件主要是为PortableApps.com Platform提供程序的基本信息。使用PAL创建便携软件，此目录是不可缺少的。
</p>

<p>
在appinfo.ini中这样写：
</p>

<pre class="brush:ini">
[Format]
Type=PortableApps.comFormat
Version=3.0

[Details]
Name=Evernote Portable
AppID=EvernotePortable
Publisher=Evernote Corporation | yysfire
Homepage=http://yysfire.github.io/tools/
Category=Office
Language=Multilingual
Description=Save your ideas, things you like, things you hear, and things you see.

[License]
Shareable=true
OpenSource=false
Freeware=true
CommercialUse=true

[Version]
PackageVersion=5.7.1.5586
DisplayVersion=5.7.1

[Control]
Icons=1
Start=EvernotePortable.exe
</pre>

<h3 id="toc_1.3.2">图标</h3>

<p>
导出Evernote.exe的图标，推荐使用<a href="http://portableapps.com/apps/graphics_pictures/icofx_portable">IcoFX Portable</a>，保存为<code>App\AppInfo\appicon.ico</code>，并导出为appicon_16.png（16px），appicon_32.png（32px），appicon_128.png（128px，非必须），均放在<code>App\AppInfo\</code>路径下。
</p>

<h3 id="toc_1.3.3">Launcher</h3>

<p>
创建<code>App\Appinfo\Launcher\EvernotePortable.ini</code>，这个INI是制作便携软件的关键，它告诉PAL如何使我们的软件便携化。
</p>

<p>
_参考：<a href="http://www.portableappc.com/guide/pal-guide/">使用Portableapps.com Launcher制作便携软件：以Evernote Portable为例</a>_
</p>

<pre class="brush:ini">
[Launch]
ProgramExecutable=Evernote\Evernote.exe
;主程序位置
SinglePortableAppInstance=true
;只允许运行一个便携版实例
CloseEXE=EvernoteTray.exe
;除了Evernote.exe，当EvernoteTray.exe正在运行时，便携软件也拒绝启动。
WaitForExe1=EvernoteTray.exe
;当Evernote.exe关闭后，等待EvernoteTray.exe进程退出,EvernotePortable.exe才退出，才真正结束便携软件。
DirectoryMoveOK=yes
;路径改变并不会影响便携软件运行，因此检测到路径改变时不提示警告。

[Activate]
Registry=true
;表示本软件需要写注册表

[DirectoriesMove]
-=%LOCALAPPDATA%\Evernote
;当软件启动时，原%LOCALAPPDATA%\Evernote会被重命名（备份）为
;%LOCALAPPDATA%\Evernote-Backup-by-EvernotePortable，当软
;件结束时，%LOCALAPPDATA%\Evernote会被删除，
;%LOCALAPPDATA%\Evernote-Backup-by-EvernotePortable 被重命名（恢复）
;为%LOCALAPPDATA%\Evernote。（-=）的意思是程序结束时不将
;%LOCALAPPDATA%\Evernote备份到便携软件Data目录，因为这几个目录主要是日志、
;临时文件，没有备份到便携设备的必要。如果需要备份到Data目录，则将“-”指定为其
;他名称。下同。
-=%APPDATA%\Evernote
-=%USERPROFILE%\AppData\LocalLow\Evernote

[DirectoriesCleanupIfEmpty]
1=%LOCALAPPDATA%\Evernote\Evernote
;如为空目录，则在结束时删除目录，避免留下垃圾文件。下同
2=%LOCALAPPDATA%\Evernote
3=%APPDATA%\Evernote
4=%USERPROFILE%\AppData\LocalLow\Evernote

[RegistryKeys]
EvernotePortable=HKCU\Software\Evernote
;在程序启动时，HKCU\Software\Evernote被重命名为
;HKCU\Software\Evernote-Backup-by-EvernotePortable，
;Data\settings\EvernotePortable.reg 被导入注册表，在程
;序结束后，反过来导出便携软件键值，恢复本机注册表项。

[RegistryValueWrite]
HKCU\Software\Evernote\Evernote\EvernotePath=REG_SZ:%PAL:DataDir%
;在程序启动时，在HKCU\Software\Evernote\Evernote\EvernotePath 中写入便携
;软件Data目录路径，以将数据库目录设定为便携软件的Data。更多PAL专有变量请参阅文档。

[RegistryCleanupIfEmpty]
1=HKCU\Software\Evernote
;如为空项，则在结束时删除，避免留下注册表垃圾。
</pre>

<h3 id="toc_1.3.4">DefaultData</h3>

<p>
PortableApps.com Platform 便携软件一般是不能通过软件自身的升级方式更新的，因此，我们需要修改程序的默认设置，关闭自动升级选项。通过观察注册表，可知Evernote自动升级主要由2个键值控制。在程序第一次运行时，需要将这两个键值设为0，以关闭默认升级。
</p>

<p>
新建<code>App\DefaultData\settings\EvernotePortable.reg</code>，写入如下内容：
</p>
<pre>
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\Software\Evernote\Evernote]
"UpdateToPreReleaseVersion"=dword:00000000
"CheckForUpdatesAtLaunch"=dword:00000000
</pre>

<h3 id="toc_1.3.5">Custom Code</h3>

<p>
Evernote有一个残余进程EvernoteClipper.exe，并不会在程序结束后自动退出。PAL并没有结束进程的功能，因此需要用到一段Custom Code。在<code>App\AppInfo\Launcher</code>目录下新建Custom.nsh，写入如下内容：
</p>

<pre>
${SegmentFile}

${SegmentPrePrimary}
KillProcDLL::KillProc "EvernoteClipper.exe"
!macroend

${SegmentPostPrimary}
KillProcDLL::KillProc "EvernoteClipper.exe"
!macroend
</pre>

<p>
此代码的作用是调用NSIS的KillPorcDLL插件，在程序启动之前和退出之后，结束进程EvernoteClipper.exe。但是，似乎并不起作用。
</p>

<p>
其实，EvernoteClipper.exe并没有什么大作用，关闭它对主程序没什么影响，而它的启动是由注册表中的一个键值
<code>HKEY_CURRENT_USER\Software\Evernote\Evernote\StartEvernoteClipper</code>
来控制。因此，我们可以在<code>App\DefaultData\settings\EvernotePortable.reg</code>中加入<code>"StartEvernoteClipper"=dword:00000000</code>来关闭它的启动。
</p>

<p>
我在前面还提到，在Evernote首次启动时，会添加“发送到Evernote”的右键菜单。但是，当Evernote程序退出后，此右键菜单还存在，这不符合便携软件的理念。
</p>

<p>
解决这个问题无外乎两种思路：
</p>

<ol>
<li>
思路一：完全抛弃此右键菜单，想办法让Evernote不安装这个菜单。

<li>
思路二：右键发送到Evernote的菜单有时还是挺好用的，当启动便携版Evernote时，生成此菜单，当便携版Evernote退出后，就删掉此菜单。

</ol>

<p>
对于思路一，我找到了控制Evernote安装右键菜单的注册表键值：<code>HKEY_CURRENT_USER\Software\Evernote\Evernote\SendToLinkInstalled</code>，在<code>App\DefaultData\settings\EvernotePortable.reg</code>中将此键值清零，结果好象不起作用。
</p>

<p>
对于思路二，可以在<code>App\AppInfo\Launcher\Custom.nsh</code>中写入以下代码解决：
</p>

<pre>
!define SENDTO   `$SENDTO\Evernote.lnk`

${SegmentFile}

${SegmentPrePrimary}
    ExpandEnvStrings $0 "%PAL:AppDir%\Evernote\Evernote.exe"
    CreateShortCut `${SENDTO}` `$0`
!macroend

${SegmentPostPrimary}
    Delete `${SENDTO}`
!macroend
</pre>

<p>
综合以上，文件<code>D:\PortableApps\EvernotePortable\App\AppInfo\Launcher\Custom.nsh</code>最终的内容如下：
</p>

<pre>
!define SENDTO   `$SENDTO\Evernote.lnk`

${SegmentFile}

${SegmentPrePrimary}
    ExpandEnvStrings $0 "%PAL:AppDir%\Evernote\Evernote.exe"
    CreateShortCut `${SENDTO}` `$0`
    KillProcDLL::KillProc "EvernoteClipper.exe"
!macroend

${SegmentPostPrimary}
    Delete `${SENDTO}`
    KillProcDLL::KillProc "EvernoteClipper.exe"
!macroend
</pre>

<p>
文件<code>App\DefaultData\settings\EvernotePortable.reg</code>最终的内容如下：
</p>

<pre>
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USER\Software\Evernote\Evernote]
"UpdateToPreReleaseVersion"=dword:00000000
"CheckForUpdatesAtLaunch"=dword:00000000
"StartEvernoteClipper"=dword:00000000
"SendToLinkInstalled"=dword:00000000
</pre>

<h2 id="toc_1.4">编译与封包</h2>

<p>
Evernote的便携化基本完成了。在
<a href="http://portableapps.com/apps/development/portableapps.com_launcher">PortableApps.com Launcher</a>
中载入 EvernotePortable 目录，按下一步编译。如果成功，会在 EvernotePortable 目录下生成 EvernotePortable.exe。
</p>

<p>
至此便携软件已经制作完毕，为便于使用与分发，可使用
<a href="http://portableapps.com/apps/utilities/portableapps.com_appcompactor">PortableApps.com AppCompactor</a>
减小软件体积，使用
<a href="http://portableapps.com/apps/development/portableapps.com_installer">PortableApps.com Installer</a> 制作成安装（自解压）包。
</p>

<h2 id="toc_1.5">扩展阅读</h2>

<ol>
<li>
<a href="http://portableapps.com/development/portableapps.com_format">PortableApps.com Format Specification (3.0)</a>

<li>
<a href="http://portableapps.com/manuals/PortableApps.comLauncher/">PortableApps.com Launcher Manual</a>

</ol>

<hr />
<h2 id="toc_1.6">Evernote便携版下载地址</h2>

<p>
<strong>EvernotePortable_5.7.1.5586 下载地址</strong> ：
</p>

<ul>
<li>
<a href="http://www.t00y.com/file/78512770">城通网盘</a>

<li>
<a href="http://pan.baidu.com/s/1jG1MbR4">百度云盘</a>

<li>
<a href="https://onedrive.live.com/?cid=3E5BAA7041F5AC70&amp;id=3E5BAA7041F5AC70!110">OneDrive</a>

</ul>

          <div id="copy"></div>
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_renren"></a>
	<a class="jiathis_button_t163"></a>
	<a class="jiathis_button_hi"></a>
	<a class="jiathis_button_fb"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_twitter"></a>
	<a class="jiathis_button_linkedin"></a>
	<a class="jiathis_button_reddit"></a>
	<a href="http://www.jiathis.com/share?uid=1645446" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1340804108559251" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UJian Button BEGIN -->
	<div class="ujian-hook"></div>
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&"></script>
<!-- UJian Button END -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1645446" async=""></script>
<!-- UY END -->
        </div> <!-- /.span9 -->
        <div class="span3">
<a class="twitter-timeline"  href="https://twitter.com/yysfirecn" data-widget-id="277690445834895360">@yysfirecn 的推文</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<!-- UYAN HOT ARTICLE BEGIN -->
<div id="uyan_hotate_unit"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1645446"></script> <!-- 如果已经过加载此行JS，即可不用重复加载 -->
<!-- UYAN HOT ARTICLE END -->
<!-- UYAN HOT COMMENT BEGIN -->
<div id="uyan_hotcmt_unit"></div>
<!-- UYAN HOT COMMENT END -->
<!-- UYAN NEW ARTICLE BEGIN -->
<div id="uyan_newate_unit"></div>
<!-- UYAN NEW ARTICLE END -->
<!-- UYAN NEW COMMENT BEGIN -->
<div id="uyan_newcmt_unit"></div>
<!-- UYAN NEW COMMENT END -->
        </div> <!-- /.span3 -->
      </div> <!-- /.row-fluid -->

      <footer class="footer">
      <p class="pull-right"><a href="#">回到顶部</a></p>
      <div id=license>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png" /></a>
        <p>除非另有声明，本站作品由<a href="https://twitter.com/yysfirecn">@幽谷奇峰</a>创作，<br />采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可。
        </p>
      </div> 
      <!--/#license-->
      <p>Generated by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>. Powered by <a href="https://github.com">GitHub Pages</a>.</p>
      </footer> <!-- /footer -->
    </div> <!-- /.container-fluid -->

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="../bootstrap/js/bootstrap.min.js"></script>
    <script src="../google-code-prettify/prettify.js"></script>
    <script src="../myapp.js"></script>

  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>Ubuntu 12.04 x64系统下编译ffmpeg和mplayer全程记录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="幽谷奇峰">

    <!-- Le styles -->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="../google-code-prettify/sons-of-obsidian.css" rel="stylesheet">
    <link href="../mystyle.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../ico/apple-touch-icon-57-precomposed.png">
  </head>
  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../index.html">幽谷奇峰</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="../index.html">主页</a></li>
              <li class="active"><a href="../linux/index.html">Linux</a></li>
              <li><a href="../vim/index.html">Vim</a></li>
              <li><a href="../webdesign/index.html">前端设计</a></li>
              <li><a href="../c_cpp/index.html">C和C++</a></li>
              <li><a href="../python/index.html">Python</a></li>
              <li class="divider-vertical"></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">联系我 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="https://twitter.com/yysfirecn">@推一推我</a></li>
                  <li><a href="https://www.facebook.com/yaley2">君要你死</a></li>
                  <li><a href="../about.html">给我写信</a></li>
                </ul> <!--/.dropdown-menu -->
              </li> <!--/.dropdown -->
            </ul> <!--/.nav -->
          </div> <!--/.nav-collapse -->

          <div class="pull-right">
            <form class="navbar-search" action="../search.html">
              <!--<div class="input-append">-->
                <input type="text" name="q" class="search-query input-medium" placeholder="搜索">
                <button type="submit" class="icon nav-search"><i class="icon-search icon-white"></i></button>
              <!--</div>-->
            </form>
          </div>

        </div> <!-- /.container -->
      </div> <!--/.navbar-inner-->
    </div> <!--/.navbar-->
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span9">
          <ul class="breadcrumb">
            <li>
            <a href="../index.html">首页</a> <span class="divider">/</span>
            </li>
            <li>
            <a href="../linux/index.html">Linux</a> <span class="divider">/</span>
            </li>
            <li class="active">你的位置</li>
          </ul>
          
<div class="toc">
<ul>
<li><a href="#toc_1">Ubuntu 12.04 x64系统下编译ffmpeg和mplayer全程记录</a>
<ul>
<li><a href="#toc_1.1">建立Chroot环境</a>
<li><a href="#toc_1.2">安装编译依赖包</a>
<li><a href="#toc_1.3">下载源码</a>
<li><a href="#toc_1.4">编译libnut</a>
<li><a href="#toc_1.5">编译ffmpeg</a>
<li><a href="#toc_1.6">编译mplayer</a>
<li><a href="#toc_1.7">回到主系统安装</a>
<li><a href="#toc_1.8">参考资料</a>
</ul>
</ul>
</div>
<hr />
<ul>
<li>
Last Modified: 2012-10-26 14:59:25

<li>
First Created: 2012-10-25 23:14:07

</ul>
<hr />
<h1 id="toc_1">Ubuntu 12.04 x64系统下编译ffmpeg和mplayer全程记录</h1>
<h2 id="toc_1.1">建立Chroot环境</h2>
<p>
关于什么是Chroot，请查阅参考资料。
</p>
<pre class="brush:bash">
$ sudo apt-get install dchroot debootstrap
$ sudo mkdir -p /var/chroot
$ sudo mkdir -p /var/chroot/precise_amd64
$ sudo vim /etc/schroot/chroot.d/precise_amd64.conf
</pre>
  
<p>
向文件precise_amd64.conf中写入
</p>
<pre class="brush:bash">
[precise_amd64]
description=Ubuntu 12.04 Precise for amd64/x64
directory=/var/chroot/precise_amd64
users=your_user_name
groups=sbuild
root-groups=root 
run-setup-scripts=true
run-exec-scripts=true
</pre>

<pre class="brush:bash">
$ sudo debootstrap --arch amd64 precise /var/chroot/precise_amd64 http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
$ sudo cp /etc/apt/sources.list /var/chroot/precise_amd64/etc/apt/
$ sudo chroot /var/chroot/precise_amd64 #进入chroot环境，它的"/"目录实际上是主系统的"/var/chroot/precise_amd64"
$ apt-get update
</pre>
  
<h2 id="toc_1.2">安装编译依赖包</h2>
<pre class="brush:bash">
$ apt-get build-dep ffmpeg
$ apt-get build-dep mplayer
$ apt-get install libass-dev libfaac-dev libopencore-amrnb-dev libopencore-amrwb-dev librtmp-dev libtwolame-dev libvo-aacenc-dev libopenjpeg-dev liba52-0.7.4-dev libmpg123-dev libmad0-dev libdv4-dev
</pre>

<h2 id="toc_1.3">下载源码</h2>
<p>
1. libnut(AMD64特殊需求）
</p>
<pre class="brush:bash">
$ cd home/
$ svn checkout svn://svn.mplayerhq.hu/nut/src/trunk libnut
</pre>

<p>
2. Ffmpeg
</p>
<pre class="brush:bash">
$ git clone git://source.ffmpeg.org/ffmpeg.git ffmpeg
</pre>
  
<p>
3. Mplayer
</p>
<pre class="brush:bash">
$ svn checkout svn://svn.mplayerhq.hu/mplayer/trunk mplayer
</pre>

<h2 id="toc_1.4">编译libnut</h2>
<pre class="brush:bash">
$ cd libnut
$ vim config.mak
</pre>

<p>
把
</p>
<pre class="brush:bash">
CFLAGS += -Os -fomit-frame-pointer -g -Wall
</pre>

<p>
改成
</p>
<pre class="brush:bash">
CFLAGS += -Os -fomit-frame-pointer -Wall -fPIC
</pre>

<p>
保存，编译，安装
</p>
<pre class="brush:bash">
$ make libnut
$ make install-libnut
</pre>
  
<h2 id="toc_1.5">编译ffmpeg</h2>
<pre class="brush:bash">
$ cd ffmpeg
$ ./configure --enable-nonfree --enable-gpl --enable-version3 \
    --enable-shared --enable-postproc --enable-libmp3lame \
    --enable-libopenjpeg --enable-libvorbis --enable-libopencore-amrnb \
    --enable-libopencore-amrwb --enable-libxvid --enable-libx264  \
    --enable-libfaac --enable-libass --enable-libbluray --enable-librtmp \
    --enable-libtwolame --enable-libpulse --enable-libvo-aacenc --enable-gnutls \
    --enable-pthreads --disable-debug --enable-libschroedinger \
    --enable-libspeex --enable-libtheora --enable-libvpx --enable-x11grab \
    --enable-libnut --disable-podpages --disable-htmlpages --disable-txtpages \
    --enable-libgsm
$ make -j2
$ checkinstall --pkgname=ffmpeg --pkgversion=1.0.git.`date +%Y%m%d`.YYS \
    --pkgarch=amd64 --install=no --nodoc make install-progs
$ checkinstall --pkgname=ffmpeg-headers --pkgversion=1.0.git.`date +%Y%m%d`.YYS \
    --pkgarch=amd64 --install=no --nodoc make install-headers
$ checkinstall --pkgname=ffmpeg-data --pkgversion=1.0.git.`date +%Y%m%d`.YYS \
    --pkgarch=amd64 --install=no --nodoc make install-data
</pre>
  
<p>
得到三个deb包，其中，ffmpeg包是可执行文件和动静态库文件，ffmpeg-headers包是头文件，ffmpeg-data包是一些examples和转换视频和音频要用到的预设文件（ffmpeg presets）。
</p>

<h2 id="toc_1.6">编译mplayer</h2>
<pre class="brush:bash">
$ cd ../mplayer
$ cp -rt ./ ../ffmpeg/
</pre>

<p>
将mplayer/configure文件中的
</p>
<pre class="brush:bash">
if test -e ffmpeg/.svn ; then
    echo "You have an outdated FFmpeg SVN checkout in ffmpeg/, please (re)move or replace it"
    exit 1
fi

if test -e ffmpeg/mp_auto_pull ; then
    if ! (cd ffmpeg &amp;&amp; git checkout release/1.0) ; then
    if ! (cd ffmpeg &amp;&amp; git pull --rebase --ff-only) ; then
        echo "git pull failed, (re)move ffmpeg/mp_auto_pull to disable pulling"
        exit 1
    fi
    (cd ffmpeg &amp;&amp; git checkout release/1.0)
    fi
fi

if ! test -e ffmpeg ; then
    echo "No FFmpeg checkout, press enter to download one with git or CTRL+C to abort"
    read tmp
    if ! git clone --depth 1 git://source.ffmpeg.org/ffmpeg.git ffmpeg ; then
        rm -rf ffmpeg
        echo "Failed to get a FFmpeg checkout"
        exit 1
    fi
    touch ffmpeg/mp_auto_pull
fi
</pre>
<p>
注释掉。
</p>

<p>
新开一个终端，执行
</p>
<pre class="brush:bash">
$ sudo cp /proc/cpuinfo /var/chroot/precise_amd64/proc/
</pre>

<p>
回到之前的终端
</p>
<pre class="brush:bash">
$ ./configure --enable-radio --enable-radio-capture --enable-menu --enable-xvmc \
    --language="en zh_CN" --enable-runtime-cpudetection --enable-mga \
    --enable-3dfx --enable-tdfxfb --disable-jack
$ make -j2
$ checkinstall --pkgname=mplayer --pkgversion=35233.svn`date +%Y%m%d`.YYS \
    --pkgarch=amd64 --install=no --nodoc make install-mplayer
$ checkinstall --pkgname=mencoder --pkgversion=35233.svn`date +%Y%m%d`.YYS \
    --pkgarch=amd64 --install=no --nodoc make install-mencoder install-mencoder-man
</pre>

<p>
得到两个deb包，其中，mplayer包是mplayer的可执行文件，mencoder包是mencoder的可执行文件和两者的man文档。
</p>

<h2 id="toc_1.7">回到主系统安装</h2>
<p>
卸载之前安装的ffmpeg和mpalyer
</p>
<pre class="brush:bash">
$ sudo apt-get purge ffmpeg mplayer mencoder
</pre>
<p>
如果安装了smplayer，卸载mplayer时也会连同smplayer一起卸载掉。
</p>

<p>
用<code>dpkg -i deb包文件</code>命令就可以安装之前生成的deb包。如果遇到有冲突的包，就把冲突的包卸掉，再安装。
</p>

<p>
装完后，别忘了运行<code>sudo ldconfig</code>.
</p>

<p>
装完自己生成的mplayer包之后，就可以重新安装smplayer了：
</p>
<pre class="brush:bash">
$ sudo apt-get install smplayer
</pre>

<p>
最后为了防止系统将自己的老旧包（新的也一样）替换掉我们辛辛苦苦编译的包，在新立得软件包管理器中分别搜索ffmpeg,mplayer,mencoder，选中它们，点击新立得菜单-&gt;软件包-&gt;锁定版本。
</p>

<p>
也可以使用aptitude命令来锁定版本：
</p>
<pre class="brush:bash">
$ sudo aptitude hold ffmpeg mplayer mencoder
</pre>

<h2 id="toc_1.8">参考资料</h2>
<ol>
<li>
<a href="https://help.ubuntu.com/community/BasicChroot">BasicChroot</a>

<li>
<a href="https://help.ubuntu.com/community/DebootstrapChroot">DebootstrapChroot</a>

<li>
<a href="http://wiki.winehq.org/WineOn64bit">Building 32-bit Wine on a 64-bit (x86-64) system</a>

<li>
<a href="http://forum.ubuntu.org.cn/viewtopic.php?f=74&amp;t=286315">Ubuntu x64版编译安装ffmpeg,mplayer,x264全教程[原创]支持VDPAU(高清硬解)</a>

</ol>

<hr />
<p>
Tags: ffmpeg, mplayer, Ubuntu, Linux
</p>

          <div id="copy"></div>
<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_renren"></a>
	<a class="jiathis_button_t163"></a>
	<a class="jiathis_button_hi"></a>
	<a class="jiathis_button_fb"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_twitter"></a>
	<a class="jiathis_button_linkedin"></a>
	<a class="jiathis_button_reddit"></a>
	<a href="http://www.jiathis.com/share?uid=1645446" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1340804108559251" charset="utf-8"></script>
<!-- JiaThis Button END -->
<!-- UJian Button BEGIN -->
	<div class="ujian-hook"></div>
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?type=slide&"></script>
<!-- UJian Button END -->
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1645446" async=""></script>
<!-- UY END -->
        </div> <!-- /.span9 -->
        <div class="span3">
<a class="twitter-timeline"  href="https://twitter.com/yysfirecn" data-widget-id="277690445834895360">@yysfirecn 的推文</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<!-- UYAN HOT ARTICLE BEGIN -->
<div id="uyan_hotate_unit"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1645446"></script> <!-- 如果已经过加载此行JS，即可不用重复加载 -->
<!-- UYAN HOT ARTICLE END -->
<!-- UYAN HOT COMMENT BEGIN -->
<div id="uyan_hotcmt_unit"></div>
<!-- UYAN HOT COMMENT END -->
<!-- UYAN NEW ARTICLE BEGIN -->
<div id="uyan_newate_unit"></div>
<!-- UYAN NEW ARTICLE END -->
<!-- UYAN NEW COMMENT BEGIN -->
<div id="uyan_newcmt_unit"></div>
<!-- UYAN NEW COMMENT END -->
        </div> <!-- /.span3 -->
      </div> <!-- /.row-fluid -->

      <footer class="footer">
      <p class="pull-right"><a href="#">回到顶部</a></p>
      <div id=license>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/cn/88x31.png" /></a>
        <p>除非另有声明，本站作品由<a href="https://twitter.com/yysfirecn">@幽谷奇峰</a>创作，<br />采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可。
        </p>
      </div> 
      <!--/#license-->
      <p>Generated by <a href="http://code.google.com/p/vimwiki/">Vimwiki</a>. Powered by <a href="https://github.com">GitHub Pages</a>.</p>
      </footer> <!-- /footer -->
    </div> <!-- /.container-fluid -->

    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="../bootstrap/js/bootstrap.min.js"></script>
    <script src="../google-code-prettify/prettify.js"></script>
    <script src="../myapp.js"></script>

  </body>
</html>
